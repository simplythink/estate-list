<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PureWealth Pro | 台股自動化版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [v-cloak] { display: none; }
        .loading-ring { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900 font-sans">
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen flex flex-col">
        
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 px-5 py-4 flex justify-between items-center border-b border-gray-100">
            <div class="flex items-center">
                <button v-if="subView" @click="subView = null" class="mr-3 p-1 -ml-1 text-indigo-600">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-xl font-black text-indigo-600 tracking-tight">{{ subView ? typeMap[subView] : 'PureWealth' }}</h1>
            </div>
            <div class="flex space-x-2" v-if="!subView">
                <button @click="syncAllStockPrices" class="p-2 text-indigo-500 bg-indigo-50 rounded-full active:scale-95 transition-transform" :disabled="isLoading">
                    <svg v-if="!isLoading" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    <div v-else class="loading-ring"></div>
                </button>
            </div>
        </header>

        <main class="flex-1 p-5 overflow-x-hidden">
            <div v-if="view === 'assets' && !subView" class="space-y-6">
                <section class="bg-indigo-600 rounded-3xl p-6 text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest mb-1">Estimated Net Worth</p>
                        <h2 class="text-4xl font-black">${{ formatNumber(netWorth) }}</h2>
                        <div class="flex mt-6 gap-3">
                            <div class="bg-white/10 px-3 py-2 rounded-xl flex-1 text-center">
                                <p class="text-[10px] text-indigo-200 uppercase font-bold">Total Assets</p>
                                <p class="font-bold text-sm text-white">${{ formatShortNumber(totalAssets) }}</p>
                            </div>
                            <div class="bg-black/10 px-3 py-2 rounded-xl flex-1 text-center">
                                <p class="text-[10px] text-indigo-200 uppercase font-bold">Total Debts</p>
                                <p class="font-bold text-sm text-red-300">-${{ formatShortNumber(totalLiabilities) }}</p>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-wider mb-6 w-full">Asset Allocation</h3>
                    <div class="w-52 h-52 relative">
                        <canvas id="assetChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <button v-for="(name, type) in typeMap" :key="type" @click="subView = type" 
                        class="bg-white p-4 rounded-2xl flex justify-between items-center border border-transparent active:border-indigo-200 active:bg-indigo-50 transition-all shadow-sm">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-xl mr-4 flex items-center justify-center font-bold" :style="{backgroundColor: typeColors[type] + '20', color: typeColors[type]}">
                                {{ type === 'stock_tw' ? 'TW' : '●' }}
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-sm text-gray-800">{{ name }}</p>
                                <p class="text-[10px] text-gray-400 font-medium uppercase">{{ getCount(type) }} 項目</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-sm mr-2" :class="isLiability(type) ? 'text-red-500' : 'text-gray-700'">
                                {{ isLiability(type) ? '-' : '' }}${{ formatNumber(getGroupTotal(type)) }}
                            </span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-gray-300">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>
                        </div>
                    </button>
                </div>
            </div>

            <div v-if="subView" class="space-y-6">
                
                <div v-if="subView === 'stock_tw'" class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="font-black text-sm text-gray-800 mb-4 flex justify-between">
                        新增台股項目 
                        <span class="text-[10px] text-indigo-500 font-medium px-2 py-0.5 bg-indigo-50 rounded-full">自動對帳</span>
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input v-model="newItem.symbol" placeholder="代號 (例: 2330)" class="col-span-1 bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500 font-bold">
                        <input v-model.number="newItem.shares" type="number" inputmode="numeric" placeholder="持有股數" class="col-span-1 bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500">
                        <button @click="addTWStock" :disabled="isLoading" class="col-span-2 bg-indigo-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-indigo-100 active:scale-95 transition-all flex justify-center items-center">
                            <span v-if="!isLoading">確認新增</span>
                            <div v-else class="loading-ring border-t-white"></div>
                        </button>
                    </div>
                </div>

                <div v-else class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="font-black text-sm text-gray-800 mb-4">新增 {{ typeMap[subView] }} 項目</h3>
                    <div class="space-y-3">
                        <input v-model="newItem.name" placeholder="項目名稱" class="w-full bg-gray-50 border-0 p-3 rounded-2xl text-sm focus:ring-2 focus:ring-indigo-500">
                        <input v-model.number="newItem.value" type="number" inputmode="numeric" placeholder="金額 / 現值" class="w-full bg-gray-50 border-0 p-3 rounded-2xl text-lg font-bold focus:ring-2 focus:ring-indigo-500">
                        <button @click="addItem('assets')" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-2xl active:scale-95 transition-all">確認新增</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center px-2">
                        <h3 class="text-gray-400 font-bold text-xs uppercase tracking-wider">項目清單</h3>
                        <span v-if="subView === 'stock_tw'" class="text-[10px] text-gray-400 italic">資料來源：TWSE OpenAPI</span>
                    </div>
                    
                    <div v-if="getGroupItems(subView).length > 0" class="space-y-3">
                        <div v-for="item in getGroupItems(subView)" :key="item.id" class="bg-white px-5 py-4 rounded-2xl flex justify-between items-center shadow-sm border border-gray-50">
                            <div>
                                <p class="font-bold text-sm text-gray-800">{{ item.name }}</p>
                                <p class="text-[10px] text-gray-400 font-medium" v-if="item.symbol">
                                    {{ item.symbol }} • {{ formatNumber(item.shares) }} 股 • ${{ item.currentPrice }}
                                </p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="font-black text-sm">${{ formatNumber(item.value) }}</span>
                                <button @click="removeItem('assets', item.id)" class="text-gray-300">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center py-10 text-gray-300 text-sm italic">尚無資料</div>
                </div>
            </div>

            <div v-if="view === 'ledger'" class="space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-wider mb-6">本月收支流量分析</h3>
                    <div class="w-full h-48 relative">
                        <canvas id="ledgerChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex bg-gray-100 p-1 rounded-2xl mb-4">
                        <button @click="newItem.category = 'expense'" :class="newItem.category === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-gray-400'" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all">支出</button>
                        <button @click="newItem.category = 'income'" :class="newItem.category === 'income' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-400'" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all">收入</button>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="newItem.name" placeholder="說明" class="flex-1 bg-gray-50 border-0 p-3 rounded-2xl text-sm">
                        <input v-model.number="newItem.value" type="number" placeholder="金額" class="w-24 bg-gray-50 border-0 p-3 rounded-2xl font-bold text-center">
                        <button @click="addItem('ledger')" class="bg-indigo-600 text-white p-3 rounded-2xl shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white/90 backdrop-blur-md border-t border-gray-100 px-10 py-5 flex justify-around items-center sticky bottom-0 z-30">
            <button @click="view = 'assets'; subView = null" :class="view === 'assets' ? 'text-indigo-600' : 'text-gray-300'">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>
            </button>
            <button @click="view = 'ledger'; subView = null" :class="view === 'ledger' ? 'text-indigo-600' : 'text-gray-300'">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7"><path fill-rule="evenodd" d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v14.25c0 1.035-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 011.5 19.125V4.875zM11.25 12a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0z" clip-rule="evenodd" /></svg>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const view = ref('assets');
                const subView = ref(null);
                const isLoading = ref(false);
                const db = ref({
                    assets: [],
                    ledger: []
                });

                const typeMap = {
                    cash: '現金存款', stock_tw: '台股投資', stock_us: '美股證券',
                    real_estate: '不動產', loan: '債務借貸', credit_card: '信用卡額度'
                };

                const typeColors = {
                    cash: '#4F46E5', stock_tw: '#10B981', stock_us: '#8B5CF6',
                    real_estate: '#F59E0B', loan: '#EF4444', credit_card: '#F97316'
                };

                const newItem = ref({ name: '', value: null, symbol: '', shares: null, category: 'expense' });
                let assetChart = null;

                // --- TWSE API 邏輯 ---
                const fetchTWStockData = async (symbol) => {
                    isLoading.value = true;
                    try {
                        // 使用證交所 OpenAPI：上市個股日收盤價
                        const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL`);
                        const data = await response.json();
                        // 在清單中尋找對應代號
                        const stock = data.find(i => i.Code === symbol);
                        if (!stock) throw new Error('找不到該股票代號，請確認是否為上市股票');
                        
                        return {
                            name: stock.Name,
                            price: parseFloat(stock.ClosingPrice.replace(/,/g, ''))
                        };
                    } catch (err) {
                        alert(err.message);
                        return null;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- 優化後的台股新增邏輯 ---
                const addTWStock = async () => {
                    if (!newItem.value.symbol || !newItem.value.shares) {
                        alert("請輸入完整代號與股數");
                        return;
                    }
                    
                    isLoading.value = true;
                    try {
                        // 嘗試從證交所抓取最新行情 (包含 ETF)
                        const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL`);
                        
                        if (!response.ok) throw new Error('API 反應異常');
                        
                        const data = await response.json();
                        const symbol = newItem.value.symbol.trim();
                        const stock = data.find(i => i.Code === symbol);
                        
                        if (stock) {
                            // 抓到資料，自動計算
                            const price = parseFloat(stock.ClosingPrice.replace(/,/g, ''));
                            const name = stock.Name;
                            
                            saveStockToDB(symbol, name, price, newItem.value.shares);
                            alert(`成功加入：${name}`);
                        } else {
                            // 找不到代號 (或是 API 資料未包含該項目)
                            handleManualFallback(symbol);
                        }
                    } catch (err) {
                        console.error("API Error:", err);
                        // 如果因為 CORS 或網路失敗，進入手動模式
                        handleManualFallback(newItem.value.symbol);
                    } finally {
                        isLoading.value = false;
                    }
                };
                
                // 輔助函式：當 API 失效時觸發手動輸入
                const handleManualFallback = (symbol) => {
                    const manualName = prompt(`自動抓取失敗 (可能是網路或 CORS 限制)。\n請手動輸入 [${symbol}] 的名稱：`, "台灣50");
                    if (!manualName) return;
                    
                    const manualPrice = prompt(`請輸入 [${manualName}] 的當前單價：`, "180.5");
                    if (!manualPrice) return;
                    
                    saveStockToDB(symbol, manualName, parseFloat(manualPrice), newItem.value.shares);
                };
                
                // 輔助函式：儲存到資料庫
                const saveStockToDB = (symbol, name, price, shares) => {
                    const val = price * shares;
                    const item = {
                        id: Date.now(),
                        type: 'stock_tw',
                        name: name,
                        symbol: symbol,
                        shares: shares,
                        currentPrice: price,
                        value: val,
                        date: new Date().toLocaleDateString()
                    };
                    db.value.assets.unshift(item);
                    // 清空輸入
                    newItem.value.symbol = '';
                    newItem.value.shares = null;
                };
                const syncAllStockPrices = async () => {
                    const stockItems = db.value.assets.filter(i => i.type === 'stock_tw' && i.symbol);
                    if (stockItems.length === 0) return;

                    isLoading.value = true;
                    try {
                        const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL`);
                        const data = await response.json();
                        
                        db.value.assets = db.value.assets.map(item => {
                            if (item.type === 'stock_tw' && item.symbol) {
                                const latest = data.find(d => d.Code === item.symbol);
                                if (latest) {
                                    const newPrice = parseFloat(latest.ClosingPrice.replace(/,/g, ''));
                                    return { ...item, currentPrice: newPrice, value: newPrice * item.shares };
                                }
                            }
                            return item;
                        });
                        alert('已成功同步台股市值！');
                    } catch (e) {
                        alert('更新失敗，請檢查網路。');
                    } finally {
                        isLoading.value = false;
                    }
                };

                // --- 基礎邏輯 ---
                const isLiability = (t) => ['loan', 'credit_card'].includes(t);
                const getGroupItems = (t) => db.value.assets.filter(i => i.type === t);
                const getGroupTotal = (t) => getGroupItems(t).reduce((s, i) => s + (i.value || 0), 0);
                const getCount = (t) => getGroupItems(t).length;

                const totalAssets = computed(() => db.value.assets.filter(i => !isLiability(i.type)).reduce((s, i) => s + i.value, 0));
                const totalLiabilities = computed(() => db.value.assets.filter(i => isLiability(i.type)).reduce((s, i) => s + i.value, 0));
                const netWorth = computed(() => totalAssets.value - totalLiabilities.value);

                const addItem = (section) => {
                    if (!newItem.value.name || !newItem.value.value) return;
                    db.value[section].unshift({
                        id: Date.now(), name: newItem.value.name, value: newItem.value.value,
                        type: subView.value, category: newItem.value.category, date: new Date().toLocaleDateString()
                    });
                    newItem.value.name = ''; newItem.value.value = null;
                };

                const removeItem = (section, id) => {
                    if (confirm('確定刪除？')) db.value[section] = db.value[section].filter(i => i.id !== id);
                };

                const formatNumber = (n) => new Intl.NumberFormat().format(Math.round(n || 0));
                const formatShortNumber = (n) => n >= 10000 ? (n/10000).toFixed(1) + '萬' : n;

                // --- 初始化圖表 ---
                const updateAssetChart = () => {
                    const ctx = document.getElementById('assetChart');
                    if (!ctx || view.value !== 'assets' || subView.value) return;
                    const activeTypes = Object.keys(typeMap).filter(t => !isLiability(t) && getGroupTotal(t) > 0);
                    if (assetChart) assetChart.destroy();
                    assetChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: activeTypes.map(t => typeMap[t]),
                            datasets: [{ data: activeTypes.map(t => getGroupTotal(t)), backgroundColor: activeTypes.map(t => typeColors[t]), borderWidth: 0 }]
                        },
                        options: { cutout: '75%', plugins: { legend: { display: false } } }
                    });
                };

                onMounted(() => {
                    const saved = localStorage.getItem('pure_wealth_v3');
                    if (saved) db.value = JSON.parse(saved);
                    nextTick(() => updateAssetChart());
                });

                watch([db, view, subView], () => {
                    localStorage.setItem('pure_wealth_v3', JSON.stringify(db.value));
                    nextTick(() => updateAssetChart());
                }, { deep: true });

                return {
                    view, subView, db, typeMap, typeColors, newItem, isLoading,
                    totalAssets, totalLiabilities, netWorth, isLiability, 
                    getGroupItems, getGroupTotal, getCount, formatNumber, formatShortNumber,
                    addItem, addTWStock, syncAllStockPrices, removeItem
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
