<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PureWealth Pro | 穩定連線版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        [v-cloak] { display: none; }
        .loading-ring { border: 3px solid rgba(79, 70, 229, 0.1); border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">
    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen flex flex-col shadow-2xl shadow-indigo-100 bg-white">
        
        <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 px-6 py-4 flex justify-between items-center border-b border-slate-100">
            <div class="flex items-center">
                <button v-if="subView" @click="subView = null" class="mr-3 p-1 text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                    </svg>
                </button>
                <h1 class="text-xl font-black text-indigo-600 tracking-tight">{{ subView ? typeMap[subView] : 'PureWealth' }}</h1>
            </div>
            <button v-if="!subView" @click="syncAllStockPrices" :disabled="isLoading" class="p-2 bg-indigo-50 text-indigo-600 rounded-full active:scale-90 transition-all">
                <div v-if="isLoading" class="loading-ring w-5 h-5"></div>
                <svg v-else xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
        </header>

        <main class="flex-1 p-6 overflow-x-hidden">
            <div v-if="view === 'assets' && !subView" class="space-y-6">
                <section class="bg-indigo-600 rounded-[2rem] p-7 text-white shadow-xl shadow-indigo-200 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-indigo-200 text-xs font-bold uppercase tracking-[0.2em] mb-1">Total Net Worth</p>
                        <h2 class="text-4xl font-black tracking-tight">${{ formatNumber(netWorth) }}</h2>
                        <div class="flex mt-8 gap-4">
                            <div class="bg-white/10 backdrop-blur-sm p-3 rounded-2xl flex-1 border border-white/10">
                                <p class="text-[10px] text-indigo-200 uppercase font-bold mb-1">Assets</p>
                                <p class="font-bold text-base">${{ formatShortNumber(totalAssets) }}</p>
                            </div>
                            <div class="bg-slate-900/20 backdrop-blur-sm p-3 rounded-2xl flex-1 border border-white/5">
                                <p class="text-[10px] text-indigo-200 uppercase font-bold mb-1">Debts</p>
                                <p class="font-bold text-base text-rose-300">-${{ formatShortNumber(totalLiabilities) }}</p>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="grid grid-cols-1 gap-4">
                    <button v-for="(name, type) in typeMap" :key="type" @click="subView = type" 
                        class="bg-white p-5 rounded-3xl flex justify-between items-center border border-slate-100 shadow-sm hover:border-indigo-100 active:bg-indigo-50/30 transition-all">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-2xl mr-4 flex items-center justify-center text-lg shadow-inner" :style="{backgroundColor: typeColors[type] + '15', color: typeColors[type]}">
                                <span v-if="type === 'stock_tw'" class="text-xs font-black">台股</span>
                                <span v-else>●</span>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-slate-800">{{ name }}</p>
                                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-tighter">{{ getCount(type) }} 個項目</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center">
                            <span class="font-black text-slate-700 mr-2" :class="{'text-rose-500': isLiability(type)}">
                                {{ isLiability(type) ? '-' : '' }}${{ formatNumber(getGroupTotal(type)) }}
                            </span>
                        </div>
                    </button>
                </div>
            </div>

            <div v-if="subView" class="space-y-6">
                <div class="bg-indigo-50/50 p-6 rounded-[2rem] border border-indigo-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800">新增{{ typeMap[subView] }}</h3>
                        <span v-if="subView === 'stock_tw'" class="text-[10px] font-bold text-indigo-500 bg-white px-2 py-1 rounded-lg border border-indigo-100 shadow-sm">自動抓取已就緒</span>
                    </div>
                    
                    <div v-if="subView === 'stock_tw'" class="flex flex-col gap-3">
                        <div class="grid grid-cols-2 gap-3">
                            <input v-model="newItem.symbol" placeholder="代號 (例: 0050)" class="bg-white border-0 p-4 rounded-2xl text-sm font-bold shadow-sm focus:ring-2 focus:ring-indigo-500">
                            <input v-model.number="newItem.shares" type="number" placeholder="股數" class="bg-white border-0 p-4 rounded-2xl text-sm font-bold shadow-sm focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button @click="addTWStock" :disabled="isLoading" class="bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-100 active:scale-95 transition-all flex justify-center items-center">
                            <span v-if="!isLoading">確認新增</span>
                            <div v-else class="loading-ring border-t-white"></div>
                        </button>
                    </div>

                    <div v-else class="flex flex-col gap-3">
                        <input v-model="newItem.name" placeholder="名稱" class="bg-white border-0 p-4 rounded-2xl text-sm font-bold shadow-sm">
                        <input v-model.number="newItem.value" type="number" placeholder="金額" class="bg-white border-0 p-4 rounded-2xl text-lg font-black shadow-sm">
                        <button @click="addItem('assets')" class="bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">儲存資產</button>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest px-2">現有資產</h4>
                    <div v-for="item in getGroupItems(subView)" :key="item.id" class="bg-white p-5 rounded-[1.5rem] border border-slate-100 shadow-sm flex justify-between items-center group">
                        <div class="flex-1">
                            <p class="font-bold text-slate-800">{{ item.name }}</p>
                            <p v-if="item.symbol" class="text-[11px] font-bold text-slate-400 mt-0.5">
                                {{ item.symbol }} • {{ formatNumber(item.shares) }} 股 • ${{ item.currentPrice }}
                            </p>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            <span class="font-black text-slate-800">${{ formatNumber(item.value) }}</span>
                            <button @click="removeItem('assets', item.id)" class="text-slate-200 hover:text-rose-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm3 10.5a.75.75 0 000-1.5H9a.75.75 0 000 1.5h6z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white/80 backdrop-blur-md border-t border-slate-100 px-12 py-6 flex justify-around items-center">
            <button @click="view = 'assets'; subView = null" :class="view === 'assets' ? 'text-indigo-600' : 'text-slate-300'" class="transition-transform active:scale-90">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8"><path d="M11.47 3.84a.75.75 0 011.06 0l8.69 8.69a.75.75 0 101.06-1.06l-8.689-8.69a2.25 2.25 0 00-3.182 0l-8.69 8.69a.75.75 0 001.061 1.06l8.69-8.69z" /><path d="M12 5.432l8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 01-.75-.75v-4.5a.75.75 0 00-.75-.75h-3a.75.75 0 00-.75.75V21a.75.75 0 01-.75.75H5.625a1.875 1.875 0 01-1.875-1.875v-6.198a2.29 2.29 0 00.091-.086L12 5.43z" /></svg>
            </button>
            <div class="w-px h-6 bg-slate-100"></div>
            <button @click="view = 'ledger'; subView = null" :class="view === 'ledger' ? 'text-indigo-600' : 'text-slate-300'" class="transition-transform active:scale-90">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8"><path fill-rule="evenodd" d="M1.5 4.875C1.5 3.839 2.34 3 3.375 3h17.25c1.035 0 1.875.84 1.875 1.875v14.25c0 1.035-.84 1.875-1.875 1.875H3.375A1.875 1.875 0 011.5 19.125V4.875zM11.25 12a2.25 2.25 0 114.5 0 2.25 2.25 0 01-4.5 0z" clip-rule="evenodd" /></svg>
            </button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const view = ref('assets');
                const subView = ref(null);
                const isLoading = ref(false);
                const db = ref({ assets: [], ledger: [] });
                const newItem = ref({ symbol: '', shares: null, name: '', value: null });

                const typeMap = { cash: '儲蓄與現金', stock_tw: '台股/ETF', stock_us: '美股證券', loan: '債務借貸' };
                const typeColors = { cash: '#4F46E5', stock_tw: '#10B981', stock_us: '#8B5CF6', loan: '#F43F5E' };

                // 代理伺服器 URL - 使用 AllOrigins 繞過 CORS
                const proxyUrl = (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const API_STOCKS = 'https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL';
                const API_ETFS = 'https://openapi.twse.com.tw/v1/exchangeReport/ETF_DAY_ALL';

                let apiCache = null;

                const fetchStockData = async () => {
                    if (apiCache) return apiCache;
                    try {
                        const [sRes, eRes] = await Promise.all([
                            fetch(proxyUrl(API_STOCKS)).then(r => r.json()),
                            fetch(proxyUrl(API_ETFS)).then(r => r.json())
                        ]);
                        
                        // AllOrigins 會把結果放在 .contents 字串內
                        const stocks = JSON.parse(sRes.contents);
                        const etfs = JSON.parse(eRes.contents);
                        
                        apiCache = [...stocks, ...etfs].map(i => ({
                            id: (i.Code || i.ID || "").trim(),
                            name: i.Name || i.ItemName || "",
                            price: parseFloat(String(i.ClosingPrice || i.TradePrice || "0").replace(/,/g, ''))
                        }));
                        return apiCache;
                    } catch (e) {
                        throw new Error("無法繞過證交所連線限制，請確認網路或稍後再試。");
                    }
                };

                const addTWStock = async () => {
                    const symbol = newItem.value.symbol.trim();
                    if (!symbol || !newItem.value.shares) return alert("請輸入完整資料");
                    
                    isLoading.value = true;
                    try {
                        const data = await fetchStockData();
                        const found = data.find(i => i.id === symbol);
                        if (found) {
                            db.value.assets.unshift({
                                id: Date.now(),
                                type: 'stock_tw',
                                name: found.name,
                                symbol: symbol,
                                shares: newItem.value.shares,
                                currentPrice: found.price,
                                value: found.price * newItem.value.shares
                            });
                            newItem.value.symbol = ''; newItem.value.shares = null;
                        } else {
                            alert("查無代號，請檢查是否輸入正確 (例: 0050)");
                        }
                    } catch (e) { alert(e.message); }
                    finally { isLoading.value = false; }
                };

                const syncAllStockPrices = async () => {
                    if (!db.value.assets.some(i => i.type === 'stock_tw')) return;
                    isLoading.value = true;
                    apiCache = null; 
                    try {
                        const data = await fetchStockData();
                        db.value.assets = db.value.assets.map(item => {
                            if (item.type === 'stock_tw') {
                                const latest = data.find(d => d.id === item.symbol);
                                if (latest) {
                                    return { ...item, currentPrice: latest.latest, value: latest.price * item.shares };
                                }
                            }
                            return item;
                        });
                        alert("同步成功");
                    } catch (e) { alert("同步失敗"); }
                    finally { isLoading.value = false; }
                };

                const addItem = (section) => {
                    if (!newItem.value.name || !newItem.value.value) return;
                    db.value[section].unshift({
                        id: Date.now(), type: subView.value, name: newItem.value.name, value: newItem.value.value
                    });
                    newItem.value.name = ''; newItem.value.value = null;
                };

                const removeItem = (section, id) => {
                    db.value[section] = db.value[section].filter(i => i.id !== id);
                };

                const isLiability = (t) => t === 'loan';
                const getGroupItems = (t) => db.value.assets.filter(i => i.type === t);
                const getGroupTotal = (t) => getGroupItems(t).reduce((s, i) => s + i.value, 0);
                const getCount = (t) => getGroupItems(t).length;
                const totalAssets = computed(() => db.value.assets.filter(i => !isLiability(i.type)).reduce((s, i) => s + i.value, 0));
                const totalLiabilities = computed(() => db.value.assets.filter(i => isLiability(i.type)).reduce((s, i) => s + i.value, 0));
                const netWorth = computed(() => totalAssets.value - totalLiabilities.value);
                const formatNumber = (n) => new Intl.NumberFormat().format(Math.round(n || 0));
                const formatShortNumber = (n) => n >= 10000 ? (n/10000).toFixed(1) + '萬' : n;

                onMounted(() => {
                    const saved = localStorage.getItem('pw_v4');
                    if (saved) db.value = JSON.parse(saved);
                });

                watch(db, () => localStorage.setItem('pw_v4', JSON.stringify(db.value)), { deep: true });

                return { 
                    view, subView, db, newItem, typeMap, typeColors, isLoading,
                    totalAssets, totalLiabilities, netWorth, 
                    addTWStock, addItem, removeItem, syncAllStockPrices,
                    getGroupItems, getGroupTotal, getCount, isLiability, formatNumber, formatShortNumber
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
